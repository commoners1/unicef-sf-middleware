# Production Apache Configuration (High Volume)
# This file should be included in your Apache main configuration
# or used as a VirtualHost configuration

# Load required modules (ensure these are enabled in your Apache config):
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule headers_module modules/mod_headers.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule ssl_module modules/mod_ssl.so
# LoadModule ratelimit_module modules/mod_ratelimit.so (optional, for rate limiting)

# HTTP VirtualHost - Redirect to HTTPS
<VirtualHost *:80>
    ServerName api.yourdomain.com
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost *:443>
    ServerName api.yourdomain.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.yourdomain.com/privkey.pem
    
    # SSL Protocols and Ciphers
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # Security Headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Body size limit
    LimitRequestBody 10485760  # 10MB
    
    # Rate Limiting for Production (High Volume)
    # Note: mod_ratelimit may need to be installed separately
    # Alternative: Use mod_evasive or mod_security for rate limiting
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 1000  # 1000 requests per minute
    </Location>
    
    # Proxy Configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Balancer for load balancing (if multiple instances)
    <Proxy balancer://sf_middleware_production>
        BalancerMember http://127.0.0.1:3000 keepalive=on
        # Add more BalancerMember entries if you have multiple instances
        # BalancerMember http://127.0.0.1:3001 keepalive=on
    </Proxy>
    
    # Proxy Settings
    ProxyPass / balancer://sf_middleware_production/
    ProxyPassReverse / balancer://sf_middleware_production/
    
    # Proxy Headers
    ProxyPassReverse / http://127.0.0.1:3000/
    
    # Proxy Timeouts (for high volume)
    ProxyTimeout 60
    Timeout 60
    
    # Proxy Buffer Settings
    ProxyIOBufferSize 8192
    
    # Standard Proxy Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Health Check Endpoint (no rate limiting)
    <Location /health>
        ProxyPass http://127.0.0.1:3000/health
        SetEnv rate-limit off
        CustomLog logs/health_access.log combined env=!dontlog
    </Location>
    
    # Queue Monitoring (no rate limiting)
    <Location /queue/monitor>
        ProxyPass http://127.0.0.1:3000/queue/monitor
        SetEnv rate-limit off
        CustomLog logs/queue_access.log combined env=!dontlog
    </Location>
    
    # Compression (mod_deflate should be enabled)
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json
    </IfModule>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/sf-middleware-prod-error.log
    CustomLog ${APACHE_LOG_DIR}/sf-middleware-prod-access.log combined
    LogLevel warn
</VirtualHost>

