generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.1.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String           @id @default(cuid())
  email               String           @unique
  name                String
  company             String?
  password            String
  isActive            Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  failedLoginAttempts Int              @default(0)
  lastFailedLogin     DateTime?
  role                UserRole         @default(USER)
  apiKeys             ApiKey[]
  auditLogs           AuditLog[]
  errorLogs           ErrorLog[]
  refreshTokens       RefreshToken[]
  reports             Report[]
  blacklistedTokens   TokenBlacklist[]

  @@index([email])
  @@index([isActive])
  @@index([role])
  @@index([createdAt])
}

model ApiKey {
  id          String     @id @default(cuid())
  key         String
  name        String
  description String?
  isActive    Boolean    @default(true)
  permissions String[]
  userId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  environment String     @default("production")
  keyHash     String?    @unique
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs   AuditLog[]

  @@unique([userId, environment])
  @@index([keyHash])
  @@index([userId])
  @@index([isActive])
  @@index([environment])
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  apiKeyId      String?
  action        String
  endpoint      String
  method        String
  type          String?
  requestData   Json?
  responseData  Json?
  statusCode    Int
  ipAddress     String
  userAgent     String?
  duration      Int?
  isDelivered   Boolean  @default(false)
  createdAt     DateTime @default(now())
  referenceId   String?
  salesforceId  String?
  statusMessage String?
  statusPayment String?
  apiKey        ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([apiKeyId])
  @@index([createdAt])
  @@index([statusCode])
  @@index([action])
  @@index([type])
  @@index([referenceId])
  @@index([salesforceId])
  @@index([statusPayment])
  @@index([ipAddress])
}

model JobAudit {
  id             String   @id @default(cuid())
  idempotencyKey String   @unique
  payload        Json
  status         String   @default("queued")
  attempts       Int      @default(0)
  sfStatus       String?
  sfResponse     Json?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([idempotencyKey])
  @@index([status])
  @@index([createdAt])
}

model Report {
  id            String    @id @default(cuid())
  name          String
  type          String
  description   String?
  filePath      String?
  format        String
  status        String    @default("ready")
  size          Int?
  schedule      String    @default("Manual")
  lastGenerated DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([schedule])
  @@index([createdAt])
  @@index([userId])
}

model SystemSetting {
  id        String   @id @default(cuid())
  category  String
  key       String
  value     String
  valueType String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([category, key])
  @@index([category])
}

model ErrorLog {
  id          String    @id @default(cuid())
  message     String
  type        String
  source      String
  stackTrace  String?
  userId      String?
  userAgent   String?
  ipAddress   String?
  url         String?
  method      String?
  statusCode  Int?
  timestamp   DateTime  @default(now())
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  tags        String[]
  environment String
  metadata    Json?
  occurrences Int       @default(1)
  firstSeen   DateTime  @default(now())
  lastSeen    DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([source])
  @@index([resolved])
  @@index([environment])
  @@index([createdAt])
  @@index([lastSeen])
  @@index([userId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isRevoked])
}

model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  tokenType String
  userId    String?
  expiresAt DateTime
  reason    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([tokenType])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}
